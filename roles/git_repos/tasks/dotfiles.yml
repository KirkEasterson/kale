---
- name: Check if dotfiles exists
  ansible.builtin.stat:
    path: "{{ dotfiles_path }}"
  register: dotfiles_dir

- name: Clone dotfiles # noqa: latest[git]
  ansible.builtin.git:
    repo: "git@github.com:KirkEasterson/.dotfiles.git"
    dest: "{{ dotfiles_path }}"
    key_file: "{{ github_key_path }}.pub"
    accept_hostkey: true
    track_submodules: true
    recursive: true
    depth: 1
  when: not dotfiles_dir.stat.exists
  changed_when: false

- name: Install stow from pacman
  become: true
  community.general.pacman:
    state: present
    name:
      - "stow"
  when: ansible_facts['os_family'] == "Archlinux"

- name: Install stow from apt
  become: true
  ansible.builtin.apt:
    install_recommends: false
    name:
      - "stow"
  when: ansible_facts['os_family'] == "Debian"

- name: Install stow from homebrew
  community.general.homebrew:
    state: present
    name:
      - "stow"
  when: ansible_facts['os_family'] == "Darwin"

- name: Install dotfiles
  become: true
  become_user: "{{ remote_regular_user }}"
  ansible.builtin.command:
    cmd: "{{ dotfiles_path }}/install.sh"
  when: not dotfiles_dir.stat.exists
  changed_when: false
